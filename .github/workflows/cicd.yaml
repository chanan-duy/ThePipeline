name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write
  checks: write

env:
  IMAGE_NAME: chananduy/thepipeline
  DOTNET_VERSION: '10.0.x'

jobs:
  notify-start:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram Start
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üöÄ CI/CD Pipeline Started for ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.event.head_commit.message }}

  versioning:
    needs: notify-start
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      semVer: ${{ steps.versioning.outputs.semVer }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v4.2.0
        with:
          versionSpec: '6.4.x'
      - name: Determine Version
        id: versioning
        uses: gittools/actions/gitversion/execute@v4.2.0

  build-test-scan:
    name: Build, Test, SAST & Pack
    needs: versioning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install SonarQube scanner
        run: dotnet tool install --global dotnet-sonarscanner

      - name: SonarQube Begin
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet-sonarscanner begin /k:"chanan-duy_ThePipeline" /o:"chanan-duy" /d:sonar.token="${{ secrets.SONAR_TOKEN }}" /d:sonar.host.url="https://sonarcloud.io"

      - name: Restore & Build
        run: |
          dotnet restore WebApi/WebApi/WebApi.csproj
          dotnet build WebApi/WebApi/WebApi.csproj --no-restore -c Release /p:Version=${{ needs.versioning.outputs.semVer }}

      - name: Unit Tests
        run: |
          dotnet test WebApi/WebApi.Test/WebApi.Test.csproj \
            --verbosity normal \
            --logger "trx;LogFileName=test_results.trx" \
            --results-directory ./TestResults

      - name: Test Report
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: 'TestResults/*.trx'

      - name: SonarQube End
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet-sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

      - name: Publish for Release
        run: dotnet publish WebApi/WebApi/WebApi.csproj -c Release -o ./publish /p:Version=${{ needs.versioning.outputs.semVer }}

      - name: Zip Release Artifacts
        run: |
          cd ./publish
          zip -r ../webapi-release.zip .
          cd ..

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: webapi-release.zip

  docker-build-push:
    name: Docker Build & Push
    needs: [ versioning, build-test-scan ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: WebApi
          file: WebApi/WebApi/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ needs.versioning.outputs.semVer }}
            ${{ env.IMAGE_NAME }}:latest

  dast-analyze:
    name: DAST Analyze
    needs: [ versioning, docker-build-push ]
    runs-on: ubuntu-latest
    steps:
      - name: Start Container for DAST
        run: |
          docker run -d -p 8080:8080 --name test-app ${{ env.IMAGE_NAME }}:${{ needs.versioning.outputs.semVer }}
          sleep 10

      - name: OWASP ZAP Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: 'http://localhost:8080'
          fail_action: false
          allow_issue_writing: false


  deploy-minikube:
    name: Deploy to Minikube (4 Zones)
    needs: [ versioning, dast-analyze ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Minikube
        uses: medyagh/setup-minikube@master
        with:
          cpu: 2
          memory: 4000m

      - name: Deploy to 4 Environments
        run: |
          kubectl create ns dev
          kubectl create ns test
          kubectl create ns stage
          kubectl create ns prod

          cat <<EOF > deployment.yaml
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: webapi
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: webapi
            template:
              metadata:
                labels:
                  app: webapi
              spec:
                containers:
                - name: webapi
                  image: ${{ env.IMAGE_NAME }}:${{ needs.versioning.outputs.semVer }}
                  ports:
                  - containerPort: 8080
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: webapi-svc
          spec:
            selector:
              app: webapi
            ports:
              - protocol: TCP
                port: 80
                targetPort: 8080
            type: ClusterIP
          EOF

          echo "Deploying to DEV..."
          kubectl apply -f deployment.yaml -n dev
          
          echo "Deploying to TEST..."
          kubectl apply -f deployment.yaml -n test
          
          echo "Deploying to STAGE..."
          kubectl apply -f deployment.yaml -n stage
          
          echo "Deploying to PROD..."
          kubectl apply -f deployment.yaml -n prod

      - name: Verify Deployments
        run: |
          sleep 15
          kubectl get pods --all-namespaces


  create-release:
    name: Create Release
    needs: [ versioning, build-test-scan, dast-analyze, deploy-minikube ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets

      - name: Build Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
              "categories": [
                {
                    "title": "## üöÄ Features",
                    "labels": ["feat", "feature"]
                },
                {
                    "title": "## üêõ Fixes",
                    "labels": ["fix", "bug"]
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.versioning.outputs.semVer }}
          name: Release v${{ needs.versioning.outputs.semVer }}
          body: |
            ## Changes in this version
            ${{ steps.build_changelog.outputs.changelog }}
          files: |
            webapi-release.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-finish:
    needs: [ create-release ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify Success
        if: ${{ needs.create-release.result == 'success' }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚úÖ Release v${{ needs.create-release.outputs.tag_name }} is READY!
            
            - Docker Image Pushed
            - Deployed to 4 Zones (Minikube)
            - Tests & Scans Passed
            - Release Notes Published

      - name: Notify Failure
        if: ${{ needs.create-release.result == 'failure' || failure() }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚ùå CI/CD Pipeline Failed!
            Check the logs on GitHub.
